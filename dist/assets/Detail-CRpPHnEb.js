import{r as v,i as $,j as h,c as C,f as c,g as s,h as f,p as q,E as a,o as m,e as n,a as o,n as _,t as r,b as x,l as z,m as F,F as M,q as P}from"./index-DrpxvrEV.js";import{g as U,c as I,d as L,e as O,j as R,f as G,h as H,i as K}from"./activity-DGlHpSGR.js";import"./api-BAtoe7S3.js";const Q={class:"p-4"},W={class:"flex items-center"},X={class:"ml-2 text-gray-400"},se={__name:"Detail",setup(Y){const d=q(),u=v({}),p=v(!1),g=v([]),y=v(""),T=async()=>{try{const{data:t}=await I(d.params.id);u.value=t}catch{a.error("加载活动失败")}},V=async()=>{try{const t=await L(d.params.id);p.value=t.data.data.enrolled??!1}catch{a.error("获取报名状态失败")}},w=async()=>{try{const{data:t}=await O(d.params.id);g.value=t}catch{a.error("加载评论失败")}},A=async()=>{try{await R(d.params.id),p.value=!0,a.success("报名成功")}catch(t){t.response?.status===400?(a.warning("您已报名过该活动"),p.value=!0):a.error("报名失败，请重试")}},E=async()=>{try{await G(d.params.id),p.value=!1,a.success("已取消报名")}catch(t){t.response?.status===404?a.warning("您尚未报名该活动"):a.error("取消失败，请重试")}},N=async()=>{if(y.value.trim())try{await H({activityId:d.params.id,content:y.value}),y.value="",a.success("评论发表成功"),await new Promise(t=>setTimeout(t,200)),await w()}catch{a.error("评论发表失败")}},k=$(()=>{const t=U();if(!t)return null;try{const e=t.split(".")[1];return JSON.parse(atob(e))}catch{return null}});function j(t){if(!k.value)return!1;const{username:e,role:i}=k.value;return i==="admin"||t.username===e}const B=async t=>{try{await K(t),a.success("已删除"),await new Promise(e=>setTimeout(e,200)),await w()}catch{a.error("删除失败")}};return h(async()=>{await T(),await V(),await w()}),(t,e)=>{const i=f("el-button"),D=f("el-icon"),b=f("el-card"),S=f("el-input"),J=f("el-popconfirm");return m(),C("div",Q,[c(i,{onClick:e[0]||(e[0]=l=>t.$router.back())},{default:s(()=>e[2]||(e[2]=[n("返回",-1)])),_:1,__:[2]}),c(b,{class:"mt-4"},{header:s(()=>[o("h2",W,[n(r(u.value.title)+" ",1),p.value?(m(),_(D,{key:0,class:"ml-2",size:"20",color:"#67C23A"},{default:s(()=>[c(z(F))]),_:1})):x("",!0)])]),default:s(()=>[o("p",null,[e[3]||(e[3]=o("strong",null,"时间：",-1)),n(r(u.value.startTime)+" ～ "+r(u.value.endTime),1)]),o("p",null,[e[4]||(e[4]=o("strong",null,"地点：",-1)),n(r(u.value.location),1)]),o("p",null,[e[5]||(e[5]=o("strong",null,"名额：",-1)),n(r(u.value.quota),1)]),o("p",null,r(u.value.desc),1),p.value?(m(),_(i,{key:1,type:"danger",onClick:E},{default:s(()=>e[7]||(e[7]=[n(" 取消报名 ",-1)])),_:1,__:[7]})):(m(),_(i,{key:0,type:"primary",onClick:A},{default:s(()=>e[6]||(e[6]=[n(" 立即报名 ",-1)])),_:1,__:[6]}))]),_:1}),c(b,{class:"mt-4"},{header:s(()=>e[8]||(e[8]=[n("活动评论",-1)])),default:s(()=>[c(S,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=l=>y.value=l),type:"textarea",rows:3,placeholder:"说点什么..."},null,8,["modelValue"]),c(i,{class:"mt-2",type:"success",onClick:N},{default:s(()=>e[9]||(e[9]=[n(" 发表 ",-1)])),_:1,__:[9]}),(m(!0),C(M,null,P(g.value,l=>(m(),C("div",{key:l.id,class:"mt-2 border-b pb-2"},[o("strong",null,r(l.username),1),o("small",X,r(l.createdAt),1),o("div",null,[n(r(l.content)+" ",1),j(l)?(m(),_(J,{key:0,title:"确定删除这条评论？",onConfirm:Z=>B(l.id)},{reference:s(()=>[c(i,{size:"small",type:"text",danger:""},{default:s(()=>e[10]||(e[10]=[n("删除",-1)])),_:1,__:[10]})]),_:2},1032,["onConfirm"])):x("",!0)])]))),128))]),_:1})])}}};export{se as default};
